<div class="dashboard-container">
  <!-- Navbar -->
  <div class="navbar fixed-top">
    <div class="left-title">Project Managements</div>
    <div class="nav-buttons">
      <!-- Time Management (All Roles) -->
      <button *ngIf="userRole === 'Admin' || userRole === 'Employee' || isPM"
              class="btn btn-primary btn-sm me-2" routerLink="/add-time">
        <i class="bi bi-clock-history"></i> Time Management
      </button>

      <!-- Add Account (Admin only) -->
      <button *ngIf="userRole === 'Admin'" 
              class="btn btn-outline-light btn-sm" (click)="openAccountForm()">
        <i class="bi bi-plus-circle"></i> Add Account
      </button>

      <!-- Add Project (Admin + PM) -->
      <button *ngIf="userRole === 'Admin' || isPM" 
              class="btn btn-outline-light btn-sm" (click)="openForm()">
        <i class="bi bi-plus-circle"></i> Add Project
      </button>

      <!-- Other buttons -->
      <button class="btn btn-outline-light btn-sm" (click)="goToAllTasks()">
        <i class="bi bi-card-list"></i> All Tasks
      </button>

      <button class="btn btn-outline-light btn-sm" (click)="goHome()">
        <i class="bi bi-house-door-fill"></i> Home
      </button>

      <span class="text-white">Welcome, {{ userName }}</span>
      <button class="btn btn-danger btn-sm ms-2" (click)="logout()">Logout</button>
    </div>
  </div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar bg-dark text-white p-3">
      <h5 class="mb-3">Accounts</h5>
      <div class="account-list">
        <li (click)="showAllAccounts()" 
            [ngClass]="{ 'active-account': selectedAccount === null }" 
            class="p-2 sidebar-item">
          All Accounts
        </li>
        <li *ngFor="let account of accountNames"
            (click)="filterByAccount(account)"
            [ngClass]="{ 'active-account': selectedAccount === account }"
            class="p-2 sidebar-item">
          {{ account }}
        </li>
      </div>

      <!-- PM Filter -->
      <div class="mt-3" *ngIf="assigneeOptions.length > 0">
        <strong>PM</strong>
        <div *ngFor="let pm of assigneeOptions" class="form-check small">
          <input type="checkbox"
                 class="form-check-input me-2"
                 [checked]="selectedPMs.includes(pm)"
                 (change)="togglePM(pm)">
          <label class="form-check-label">{{ pm }}</label>
        </div>
      </div>

      <!-- Status & Search Filters -->
      <div class="mt-4">
        <div class="mb-2">
          <strong>Status</strong><br/>
          <label *ngFor="let status of statusOptions" class="d-block small">
            <input type="checkbox" class="form-check-input me-2"
                   [checked]="selectedStatuses.includes(status)"
                   (change)="toggleStatus(status)" />
            {{ status }}
          </label>
        </div>

        <div class="mb-2">
          <strong>Search</strong>
          <input type="text" class="form-control form-control-sm mt-1"
                 placeholder="Search project..."
                 [(ngModel)]="searchText"
                 (input)="applyFilters()" />
        </div>

        <button class="btn btn-sm btn-secondary mt-2" (click)="clearFilters()">Clear Filters</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content">
      <!-- Account Form -->
      <app-account-form *ngIf="showAccountForm" 
                        (formClosed)="closeAccountForm()">
      </app-account-form>

      <!-- Project Form -->
      <app-project-form *ngIf="showProjectForm"
                        [selectedAccount]="selectedAccount"
                        [editingProject]="editingProject"
                        (formClosed)="closeProjectForm()">
      </app-project-form>

      <!-- Projects View -->
      <div *ngIf="!showProjectForm && !showAccountForm">
        <h2 class="text-white mb-4 small-title">
          {{ selectedAccount ? selectedAccount + "'s Projects" : "All Projects" }}
        </h2>

        <!-- Sticky Header Row -->
        <div class="project-header">
          <div>Account</div>
          <div>Project</div>
          <div>PM</div>
          <div>Status</div>
          <div>Assigned</div>
          <div>Remarks</div>
        </div>

        <!-- Project Cards -->
        <div class="project-list">
          <div class="project-card-rect"
               *ngFor="let project of filteredProjects"
               [ngClass]="{ 'bg-danger': isExpiredTask(project), 'bg-dark': !isExpiredTask(project) }">

            <!-- Project Grid Row -->
            <div class="project-row">
              <div>{{ project.account?.accountName || project.accountName || '—' }}</div>
              <div>{{ project.projectName }}</div>
              <div>{{ project.pmName || '—' }}</div>
              <div>{{ project.status || '—' }}</div>
              <div>{{ project.assignedDate || '—' }}</div>
              <div>{{ project.remarks || '—' }}</div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end px-3 pb-2">
              <button class="btn btn-sm btn-light me-2"
                      (click)="toggleTasks(project.projectName); $event.stopPropagation()">
                <i class="bi"
                   [ngClass]="{ 'bi-plus': !isProjectExpanded(project.projectName),
                                'bi-dash': isProjectExpanded(project.projectName) }"></i>
              </button>

              <button *ngIf="userRole === 'Admin' || (isPM && project.pmName === userName)"
                      class="btn btn-sm btn-warning me-2"
                      (click)="editProject(project); $event.stopPropagation()">
                <i class="bi bi-pencil"></i>
              </button>
            </div>

            <!-- Task Table -->
            <div *ngIf="isProjectExpanded(project.projectName)" class="task-list">
              <table class="table table-dark table-sm table-bordered align-middle mb-0">
                <thead>
                  <tr>
                    <th>Task Name</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Comment</th>
                    <th>End Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let task of projectTasksMap[project.projectName]"
                      [ngClass]="{ 'table-danger': isExpiredTask(task) }">
                    <td>{{ task.projectTitle }}</td>
                    <td>{{ task.status }}</td>
                    <td>{{ task.role }}</td>
                    <td>{{ task.remarks || '—' }}</td>
                    <td>{{ task.endDate }}</td>
                  </tr>
                  <tr *ngIf="!projectTasksMap[project.projectName]?.length">
                    <td colspan="5" class="text-center text-muted">
                      No tasks available for this project.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div> <!-- /project-list -->
      </div>
    </div> <!-- /content -->
  </div> <!-- /main-container -->
</div> <!-- /dashboard-container -->
